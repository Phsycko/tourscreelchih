// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String
  role      UserRole @default(GUIDE)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  reservations Reservation[]
  messages     Message[]

  @@map("users")
}

enum UserRole {
  GUIDE
  ADMIN
}

model Client {
  id        String   @id @default(cuid())
  name      String
  email     String
  phone     String
  country   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  reservations Reservation[]
  messages     Message[]

  @@map("clients")
}

model Tour {
  id          String   @id @default(cuid())
  title       String
  description String   @db.Text
  duration    Int      // in hours
  difficulty  String
  price       Float
  maxCapacity Int
  image       String?
  images      String[] // array of image URLs
  itinerary   String[] @default([])
  includes    String[] @default([])
  excludes    String[] @default([])
  requirements String[] @default([])
  schedules   String[] @default([])
  policies    String   @db.Text
  languages   String[] @default([])
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  reservations Reservation[]
  availability Availability[]

  @@map("tours")
}

model Vehicle {
  id          String   @id @default(cuid())
  name        String
  type        String
  capacity    Int
  description String   @db.Text
  images      String[] @default([])
  amenities   String[] @default([])
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  reservations Reservation[]

  @@map("vehicles")
}

model Availability {
  id        String   @id @default(cuid())
  tourId    String
  date      DateTime @db.Date
  available Boolean  @default(true)
  capacity  Int
  booked    Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tour Tour @relation(fields: [tourId], references: [id], onDelete: Cascade)

  @@unique([tourId, date])
  @@map("availability")
}

model Reservation {
  id          String            @id @default(cuid())
  tourId      String
  vehicleId   String?
  clientId    String
  userId      String? // guide who confirmed
  date        DateTime @db.Date
  time        String
  participants Int
  totalPrice  Float
  status      ReservationStatus @default(PENDING)
  paymentStatus PaymentStatus   @default(PENDING)
  paymentMethod String?
  paymentId   String?
  notes       String? @db.Text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tour    Tour     @relation(fields: [tourId], references: [id])
  vehicle Vehicle? @relation(fields: [vehicleId], references: [id])
  client  Client   @relation(fields: [clientId], references: [id])
  user    User?    @relation(fields: [userId], references: [id])
  payment Payment?

  @@map("reservations")
}

enum ReservationStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

model Payment {
  id              String        @id @default(cuid())
  reservationId   String        @unique
  amount          Float
  currency        String        @default("USD")
  provider        PaymentProvider
  providerId      String? // Stripe payment intent ID or Mercado Pago preference ID
  status          PaymentStatus
  transactionId   String?
  metadata        Json?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  reservation Reservation @relation(fields: [reservationId], references: [id], onDelete: Cascade)

  @@map("payments")
}

enum PaymentProvider {
  STRIPE
  MERCADOPAGO
}

model Message {
  id        String        @id @default(cuid())
  channel   MessageChannel
  from      String
  to        String
  subject   String?
  content   String        @db.Text
  clientId  String?
  userId    String?
  isRead    Boolean       @default(false)
  createdAt DateTime      @default(now())
  updatedAt DateTime       @updatedAt

  client Client? @relation(fields: [clientId], references: [id])
  user   User?   @relation(fields: [userId], references: [id])

  @@map("messages")
}

enum MessageChannel {
  WHATSAPP
  EMAIL
  INSTAGRAM
  FACEBOOK
  TELEGRAM
  PHONE
  FORM
}

model Notification {
  id        String           @id @default(cuid())
  type      NotificationType
  title     String
  message   String           @db.Text
  userId    String?
  isRead    Boolean          @default(false)
  metadata  Json?
  createdAt DateTime         @default(now())

  @@map("notifications")
}

enum NotificationType {
  NEW_RESERVATION
  RESERVATION_CONFIRMED
  RESERVATION_CANCELLED
  PAYMENT_RECEIVED
  MESSAGE_RECEIVED
  REMINDER
}

